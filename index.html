<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="icon.png" type="image/png" />
        <title>Motor Database</title>
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css" />
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script type="text/javascript" src="//cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    </head>
    <body>
        <div class="header">
            <a href="https://github.com/marc-frank/motor-database" class="button" target="_blank">Contribute on GitHub</a>
            <h1>Motor Database</h1>
        </div>
        <table id="myTable" class="display">
            <thead>
                <tr>
                    <!-- Dynamic header will be generated here -->
                </tr>
                <tr class="filters">
                    <!-- Search boxes will be added here -->
                </tr>
            </thead>
            <tbody>
                <!-- Data will be loaded here -->
            </tbody>
            <tfoot>
                <tr>
                    <!-- Dynamic footer will be generated here -->
                </tr>
            </tfoot>
        </table>
        <script>
            $(document).ready(function () {
                $.getJSON("database.json", function (data) {
                    data.forEach((item) => {
                        if (!item.Image || item.Image.trim() === "") {
                            item.Image = "https://upload.wikimedia.org/wikipedia/commons/a/ac/No_image_available.svg";
                        }
                    });

                    var uniqueKeys = new Set();
                    data.forEach((item) => {
                        Object.keys(item).forEach((key) => {
                            uniqueKeys.add(key);
                        });
                    });

                    var sortedKeys = Array.from(uniqueKeys).sort();
                    var startKeys = ["Image", "Manufacturer", "Name", "Price ($)", "Stator Diameter (mm)", "Stator Height (mm)"];
                    var endKey = "Link";
                    sortedKeys = startKeys.concat(sortedKeys.filter((key) => !startKeys.includes(key) && key !== endKey));
                    sortedKeys.push(endKey);

                    var headerFooterRow = "";
                    sortedKeys.forEach((key) => {
                        headerFooterRow += "<th>" + key + "</th>";
                    });
                    $("#myTable thead tr, #myTable tfoot tr").html(headerFooterRow);

                    // Clone the header for the filter inputs
                    $("#myTable thead tr").clone(true).addClass("filters").appendTo("#myTable thead");

                    var columns = sortedKeys.map((key) => {
                        var columnDef = { data: key, defaultContent: "" };
                        if (key === "Image") {
                            columnDef.render = function (data) {
                                return data ? '<img src="' + data + '" alt="Image" width="128" height="128">' : "";
                            };
                        } else if (key === "Link") {
                            columnDef.render = function (data) {
                                return data ? '<a href="' + data + '" target="_blank">' + data + "</a>" : "";
                            };
                        }
                        return columnDef;
                    });

                    var table = $("#myTable").DataTable({
                        data: data,
                        columns: columns,
                        lengthMenu: [
                            [10, 25, 50, 100, 250, -1],
                            [10, 25, 50, 100, 250, "All"],
                        ],
                        pageLength: 10,
                        orderCellsTop: true,
                        fixedHeader: true,
                        initComplete: function () {
                            var api = this.api();

                            // Setup search input for each column
                            api.columns().every(function () {
                                var column = this;
                                var input = $('<input type="text" placeholder="Search ' + $(column.header()).text() + '" />')
                                    .appendTo($(column.footer()).empty())
                                    .on("keyup change", function () {
                                        column.search($(this).val()).draw();
                                    });
                            });
                        },
                    });
                });
            });
        </script>
    </body>
</html>
